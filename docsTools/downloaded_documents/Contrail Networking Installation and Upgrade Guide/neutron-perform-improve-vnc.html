<p id="topic-content"><h1 id="jd0e2">Working with Neutron</h1><sw-topic-details date="2020-09-16"> </sw-topic-details><div id="intro"><div class="mini-toc-intro"><p>OpenStack’s networking solution, Neutron,
has representative elements for Contrail elements for Network (VirtualNetwork),
Port (VirtualMachineInterface), Subnet (IpamSubnets), and Security-Group.
The Neutron plugin translates the elements from one representation
to another.</p></div></div><h2 id="id-data-structure">Data Structure</h2><p>Although the actual data between Neutron and Contrail is similar,
the listings of the elements differs significantly. In the Contrail
API, the networking elements list is a summary, containing only the
UUID, FQ name, and an href, however, in Neutron, all details of each
resource are included in the list.  </p><p>The Neutron plugin has an inefficient list retrieval operation,
especially at scale, because it:</p><ul><li style=""><p>reads a list of resources (for example. <code class="inline" v-pre="">GET
/virtual-networks</code>), then </p></li><li style=""><p>iterates and reads in the details of the resource (<code class="inline" v-pre="">GET /virtual-network/<var v-pre="">&lt;uuid&gt;</var></code> ). </p></li></ul><p>As a result, the API server spends most of the time in this
type of GET operation just waiting for results from the Cassandra
database.  </p><p>The following features in Contrail improve performance with
Neutron: </p><ul><li style=""><p>An optional detail query parameter is added in the GET
of collections so that the API server returns details of all the resources
in the list, instead of just a summary. This is accompanied by changes
in the Contrail API library so that a caller gets returned a list
of the objects. </p></li><li style=""><p>The existing Contrail list API takes in an optional <code class="inline" v-pre="">parent_id</code> query parameter to return information about
the resource anchored by the parent.</p></li><li style=""><p>The Contrail API server reads objects from Cassandra in
a multiget format into <code class="inline" v-pre="">obj_uuid_cf</code>, where
object contents are stored, instead of reading in an xget/get format.
This reduces the number of round-trips to and from the Cassandra database.</p></li></ul><h2 id="id-network-sharing-in-neutron">Network Sharing in Neutron</h2><p>Using Neutron, a deployer can make a network accessible to other
tenants or projects by using one of two attributes on a network:  </p><ul><li style=""><p>Set the <code class="inline" v-pre="">shared</code> attribute to
allow sharing.</p></li><li style=""><p>Set the <code class="inline" v-pre="">router:external</code> attribute,
when the plugin supports an <code class="inline" v-pre="">external_net</code> extension.</p></li></ul><p><em>Using the Shared Attribute</em></p><p>When a network has the <code class="inline" v-pre="">shared</code> attribute
set, users in other tenants or projects, including non-admin users,
can access that network, using: </p><p> <code class="inline" v-pre="">neutron net-list --shared </code> </p><p>Users can also launch a virtual machine directly on that network,
using: </p><p><code class="inline" v-pre=""> nova boot <var v-pre="">&lt;other-parameters&gt;</var> –nic net-id=<var v-pre="">&lt;shared-net-id&gt;</var></code></p><p><em>Using the Router:External Attribute</em></p><p>When a network has the <code class="inline" v-pre="">router:external</code> attribute set, users in other tenants or projects, including non-admin
users, can use that network for allocating floating IPs, using:</p><p> <code class="inline" v-pre="">neutron floatingip-create <var v-pre="">&lt;router-external-net-id&gt;</var></code> </p><p>then associating the IP address pool with their instances.</p><sw-admonition name="note" style=""><strong class="title">Note</strong><p>The VN hosting the FIP pool should be marked shared and
external.</p></sw-admonition><h2 id="id-commands-for-neutron-network-sharing">Commands for Neutron Network Sharing</h2><p>The following table summarizes the most common Neutron commands
used with Contrail.</p><sw-table><table cellspacing="0" style="border-top:thin solid black;" width="99%"><thead><tr valign="bottom"><th align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Action</p></th><th align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Command</p></th></tr></thead><tbody><tr valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>List all shared networks.</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p><code class="inline" v-pre="">neutron net-list --shared</code></p></td></tr><tr class="row-with-bg" valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Create a network that has the shared attribute.</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p><code class="inline" v-pre="">neutron net-create <var v-pre="">&lt;net-name&gt;</var> –shared</code></p></td></tr><tr valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Set the shared attribute on an existing network.</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p><code class="inline" v-pre="">neutron net-update <var v-pre="">&lt;net-name&gt;</var> -shared</code></p></td></tr><tr class="row-with-bg" valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>List all <code class="inline" v-pre="">router:external</code> networks.</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p><code class="inline" v-pre="">neutron net-list --router:external</code></p></td></tr><tr valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Create a network that has the <code class="inline" v-pre="">router:external</code>attribute.</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p><code class="inline" v-pre="">neutron net-create <var v-pre="">&lt;net-name&gt;</var> -router:external</code></p></td></tr><tr class="row-with-bg" valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Set the <code class="inline" v-pre="">router:external</code> attribute
on an existing network.</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p><code class="inline" v-pre="">neutron net-update <var v-pre="">&lt;net-name&gt;</var> -router:external</code></p></td></tr></tbody></table></sw-table><h2 id="id-support-for-neutron-apis">Support for Neutron APIs </h2><p>The OpenStack Neutron project provides virtual networking services
among devices that are managed by the OpenStack compute service. Software
developers create applications by using the OpenStack Networking API
v2.0 (Neutron).  </p><p>Contrail provides the following features to increase support
for OpenStack Neutron:  </p><ul><li style=""><p>Create a port independently of a virtual machine. </p></li><li style=""><p>Support for more than one subnet on a virtual network. </p></li><li style=""><p>Support for allocation pools on a subnet.</p></li><li style=""><p>Per tenant quotas.</p></li><li style=""><p> Enabling DHCP on a subnet.</p></li><li style=""><p>External router can be used for floating IPs. </p></li></ul><p>For more information about using OpenStack Networking API v2.0
(Neutron), refer to: <a href="http://docs.openstack.org/api/openstack-network/2.0/content/​">http://docs.openstack.org/api/openstack-network/2.0/content/​ </a>and the OpenStack Neutron Wiki at: <a href="http://wiki.openstack.org/wiki/Neutron">http://wiki.openstack.org/wiki/Neutron</a>.</p><h2 id="id-contrail-neutron-plugin">Contrail Neutron Plugin </h2><p>The Contrail Neutron plugin provides an implementation for the
following core resources: </p><ul><li style=""><p>Network</p></li><li style=""><p>Subnet</p></li><li style=""><p>Port</p></li></ul><p>It also implements the following standard and upstreamed Neutron
extensions: </p><ul><li style=""><p>Security group</p></li><li style=""><p>Router IP and floating IP</p></li><li style=""><p>Per-tenant quota</p></li><li style=""><p>Allowed address pair </p></li></ul><p>The following Contrail-specific extensions are implemented: </p><ul><li style=""><p>Network IPAM</p></li><li style=""><p>Network policy</p></li><li style=""><p>VPC table and route table</p></li><li style=""><p>Floating IP pools</p></li></ul><p>The plugin does not implement native bulk, pagination, or sort
operations and relies on emulation provided by the Neutron common
code. </p><h2 id="id-dhcp-options">DHCP Options</h2><p>In Neutron commands, DHCP options can be configured using extra-dhcp-options
in port-create.</p><div class="example" dir="ltr" id="jd0e302"><p><b><h3 id="jd0e303">Example</h3></b></p><sw-code><template v-pre=""><pre>neutron port-create net1 --extra-dhcp-opt opt_name=&lt;dhcp_option_name&gt;,opt_value=&lt;value&gt;</pre></template></sw-code></div><p>The opt_name and opt_value pairs that can be used are maintained
in GitHub:  <a href="https://github.com/Juniper/contrail-controller/wiki/Extra-DHCP-Options">https://github.com/Juniper/contrail-controller/wiki/Extra-DHCP-Options</a> .</p><h2 id="id-incompatibilities">Incompatibilities</h2><p>In the Contrail architecture, the following are known incompatibilities
with the Neutron API. </p><ul><li style=""><p>Filtering based on any arbitrary key in the resource is
not supported. The only supported filtering is by <code class="inline" v-pre="">id,
name,</code> and <code class="inline" v-pre="">tenant_id</code>. </p></li><li style=""><p>To use a floating IP, it is not necessary to connect the
public subnet and the private subnet to a Neutron router. Marking
a public network with <code class="inline" v-pre="">router:external</code> is
sufficient for a floating IP to be created and associated, and packet
forwarding to it will work. </p></li><li style=""><p>The default values for quotas are sourced from <code class="filepath">/etc/contrail/contrail-api.conf </code>and not from<code class="filepath"> /etc/neutron/neutron.conf.</code></p></li></ul><sw-prev-next> </sw-prev-next></p>