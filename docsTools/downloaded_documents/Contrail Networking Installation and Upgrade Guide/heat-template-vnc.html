<p id="topic-content"><h1 id="jd0e3">Using the Contrail Heat Template</h1><sw-topic-details date="2020-03-31"> </sw-topic-details><div id="intro"><div class="mini-toc-intro"><p>Heat is the orchestration engine of the OpenStack
program. Heat enables launching multiple cloud applications based
on templates that are comprised of text files.</p></div></div><h2 id="jd0e19">Introduction to Heat</h2><p>A Heat template describes the infrastructure for a cloud application,
such as networks, servers, floating IP addresses, and the like, and
can be used to manage the entire life cycle of that application.</p><p>When the application infrastructure changes, the Heat templates
can be modified to automatically reflect those changes. Heat can also
delete all application resources if the system is finished with an
application.</p><p>Heat templates can record the relationships between resources,
for example, which networks are connected by means of policy enforcements,
and consequently call OpenStack REST APIs that create the necessary
infrastructure, in the correct order, needed to launch the application
managed by the Heat template. </p><h2 id="jd0e28">Heat Architecture</h2><p>Heat is implemented by means of Python applications, including
the following: </p><ul><li style=""><p><code class="inline" v-pre="">heat-client</code>—The CLI tool
that communicates with the <code class="inline" v-pre="">heat-api</code> application
to run Heat APIs. </p></li><li style=""><p><code class="inline" v-pre="">heat-api</code>—Provides an
OpenStack native REST API that processes API requests by sending them
to the Heat engine over remote procedure calls (RPCs). </p></li><li style=""><p><code class="inline" v-pre="">heat-engine</code>—Responsible
for orchestrating the launch of templates and providing events back
to the API consumer.</p></li></ul><h2 id="jd0e52">Support for Heat Version 2 Resources</h2><p>Starting with Contrail Release 3.0.2, Contrail Heat resources
and templates are autogenerated from the Contrail schema, using Heat
Version 2 resources. Contrail Release 3.0.2 is the minimum required
version for using Heat with Contrail in 3.x releases. The Contrail
Heat Version 2 resources are of the following hierarchy: <code class="inline" v-pre="">OS::ContrailV2::&lt;ResourceName&gt;</code>.  </p><p>The generated resources and templates are part of the Contrail
Python package, and are located in the following directory in the
target installation:</p><p><code class="filepath">/usr/lib/python2.7/dist-packages/vnc_api/gen/heat/ </code></p><p>The <code class="filepath">heat/</code> directory has the
following subdirectories:</p><ul><li style=""><p><code class="filepath">resources/</code>—Contains
all the resources for the contrail-heat plugin, which runs in the
context of the Heat engine service.</p></li><li style=""><p><code class="filepath">templates/</code>—Contains
sample templates for each resource. Each sample template presents
every possible parameter in the schema. Use the sample templates as
a reference when you build up more complex templates for your network
design.</p></li><li style=""><p><code class="filepath">env/</code>—Contains the
environment for input to each template.</p></li></ul><p>The following contains a list of all the generated plug-in resources
that are supported by contrail-heat :</p><p><a href="https://github.com/tungstenfabric/tf-heat-plugin/tree/master/contrail_heat/new_templates">https://github.com/tungstenfabric/tf-heat-plugin/tree/master/contrail_heat/new_templates</a></p><h3 id="jd0e91">Deprecation of Heat Version 1 Resources</h3><p>Heat Version 1 resources within the hierarchy <code class="inline" v-pre="">OS::Contrail::&lt;ResourceName&gt;</code> are being deprecated, and you should not create new service templates
using the Heat Version 1 templates. </p><h2 id="jd0e99">Heat Version 2 with Service Templates and Port Tuple Sample
Workflow</h2><p>With Contrail service templates Version 2, the user can create
ports and bind them to a virtual machine (VM)-based service instance,
by means of a port-tuple object. All objects created with the Version
2 service template are directly visible to the Contrail Heat engine,
and are directly managed by Heat. </p><p>The following shows the basic workflow steps for creating a
port tuple and service instance that will be managed by Heat:</p><ol type="1"><li id="jd0e108" style="">Create a service template. Select 2 in the Version field. </li><li id="jd0e111" style="">Create a service instance for the service template just
created.</li><li id="jd0e114" style="">Create a port-tuple object.</li><li id="jd0e117" style="">Create ports, using Nova VM launch or without a VM launch. </li><li id="jd0e120" style="">Label each port as left, right, mgmt, and so on, and add
the ports to the port-tuple object.<p>Use a unique label for each of the ports in a single port tuple.
The labels named left and right are used for forwarding.</p></li><li id="jd0e125" style="">Link the port tuple to a service instance.</li><li id="jd0e128" style="">Launch the service instance. </li></ol><h2 id="jd0e131">Example: Creating a Service Template Using Heat</h2><p>The following is an example of how to create a service template
using Heat.</p><ol type="1"><li id="jd0e137" style="">Define a template to create the service template. <div class="sample" dir="ltr" id="jd0e140"><div class="output" dir="ltr"><sw-code><template v-pre=""><pre>service_template.yaml
heat_template_version:  2013-‐05-‐23
description: &gt;
   HOT template to create a service template
parameters:
   name:  
      type: string
      description: Name of service template     
   mode:
      type: string
      description: service mode
   type:
      type: string   
      description: service type
   image:
      type: string
      description: Name of the image
   flavor:
      type: string     
      description: Flavor
   service_interface_type_list:
      type: string
      description: List of interface types
   shared_ip_list:
      type: string
      description: List of shared ip enabled-‐disabled
   static_routes_list:
      type: string
      description: List of static routes enabled-‐disabled
 
resources:
   service_template:
      type: OS::ContrailV2::ServiceTemplate
      properties:
         name: { get_param: name }
         service_mode: { get_param: mode }
         service_type: { get_param: type }
         image_name: { get_param: image }  
         flavor: { get_param: flavor }
         service_interface_type_list: { "Fn::Split" : [ ",", Ref: service_interface_type_list ] }
         shared_ip_list: { "Fn::Split" : [ ",", Ref: shared_ip_list ] }
         static_routes_list: { "Fn::Split" : [ ",", Ref: static_routes_list ] }
   outputs:
      service_template_fq_name:
         description: FQ name of the service template
         value: { get_attr: [ service_template, fq_name] }

}</pre></template></sw-code></div></div></li><li id="jd0e143" style="">Create an environment file to define the values to put
in the variables in the template file.<div class="sample" dir="ltr" id="jd0e146"><div class="output" dir="ltr"><sw-code><template v-pre=""><pre>service_template.env

parameters:

   name: contrail_svc_temp

   mode: transparent

   type: firewall

   image: cirros

   flavor: m1.tiny

   service_interface_type_list: management,left,right,other

   shared_ip_list: True,True,False,False     

   static_routes_list: False,True,False,False</pre></template></sw-code></div></div></li><li id="jd0e149" style="">Create the Heat stack by launching the template and the
environment file, using the following command:<div class="sample" dir="ltr" id="jd0e152"><div class="output" dir="ltr"><sw-code><template v-pre=""><pre>heat stack create stack1 –f service_template.yaml –e service_template.env</pre></template></sw-code></div></div><div class="sample" dir="ltr" id="jd0e156"><p>OR use this command for recent versions of OpenStack</p><div class="output" dir="ltr"><sw-code><template v-pre=""><pre>openstack stack create -e &lt;env-file-name&gt; -t &lt;template-file-name&gt; &lt;stack-name&gt;
</pre></template></sw-code></div></div></li></ol><sw-prev-next> </sw-prev-next></p>