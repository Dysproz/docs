<p id="topic-content"><h1 id="jd0e3">Setting Up the Infrastructure</h1><sw-topic-details date="2020-07-21"> </sw-topic-details><h2 id="id-target-configuration-example">Target Configuration (Example)</h2><p>Undercloud and overcloud KVM hosts require virtual switches
and virtual machine definitions to be configured. You can deploy any
KVM host operating system version that supports KVM and OVS. The following
example shows a RHEL/CentOS based system. If you are using RHEL, you
must subscribe the system.</p><p>The following example illustrates all control plane functions
as Virtual Machines hosted on KVM hosts.</p><p>There are different ways to create the infrastructure providing
the control plane elements. To illustrate the installation procedure,
we will use four host machines for the infrastructure, each running
KVM. KVM1 contains a VM running the undercloud while KVM2 through
KVM4 each contains a VM running an OpenStack controller and a Contrail
controller (<a href="setting-up-contrail-rhosp-infrastructure.html#ControlPlaneFunctions-379346E7">Table 1</a>).</p><sw-table><p class="SubTitle" id="ControlPlaneFunctions-379346E7">Table 1: Control
Plane Infrastructure</p><table cellspacing="0" style="border-top:thin solid black;" width="99%"><thead><tr valign="bottom"><th align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>KVM Host</p></th><th align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Virtual Machines</p></th></tr></thead><tbody><tr valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>KVM1</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>undercloud</p></td></tr><tr class="row-with-bg" valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>KVM2</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>OpenStack Controller 1, Contrail Contoller 1</p></td></tr><tr valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>KVM3</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>	OpenStack Controller 2, Contrail Contoller 2</p></td></tr><tr class="row-with-bg" valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>KVM4</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>OpenStack Controller 3, Contrail Contoller 3</p></td></tr></tbody></table></sw-table><p><a href="setting-up-contrail-rhosp-infrastructure.html#PhysicalView-379619C3">Figure 1</a> shows the physical
connectivity where each KVM host and each compute node has two interfaces
that connect to an external switch. These interfaces attach to separate
virtual bridges within the VM, allowing for two physically separate
networks (external and provisioning networks).</p><figure id="PhysicalView-379619C3"><figcaption>Figure 1: Physical View</figcaption><div class="graphic"><img alt="Physical View" src="images/g200475.png" style=""/></div></figure><p><a href="setting-up-contrail-rhosp-infrastructure.html#LogicalView-379F67C3">Figure 2</a> shows the logical
view of the connectivity where VLANs are used to provide further network
separation for the different OpenStack network types.</p><figure id="LogicalView-379F67C3"><figcaption>Figure 2: Logical View</figcaption><div class="graphic"><img alt="Logical View" src="images/g200476.png" style=""/></div></figure><p>The following sections describe how to configure the infrastructure,
the undercloud, and finally the overcloud.</p><h2 id="id-configure-the-external-physical-switch">Configure the External Physical Switch</h2><p>Configure the ports and VLANs on the external physical switch
according to the following table:</p><sw-table><p class="SubTitle" id="jd0e90">Table 2: External Physical Switch Port and VLAN
Configuration</p><table cellspacing="0" style="border-top:thin solid black;" width="99%"><thead><tr valign="bottom"><th align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Port</p></th><th align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Trunked VLAN</p></th><th align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>	Native VLAN</p></th></tr></thead><tbody><tr valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>ge0</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>-</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>-</p></td></tr><tr class="row-with-bg" valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>ge1</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>700, 720</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>-</p></td></tr><tr valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>ge2</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>700, 710, 720, 730, 740, 750</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>-</p></td></tr><tr class="row-with-bg" valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>ge3</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>-</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>-</p></td></tr><tr valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>ge4</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>710, 730</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>700</p></td></tr><tr class="row-with-bg" valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>ge5</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>-</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>-</p></td></tr></tbody></table></sw-table><h2 id="id-configure-kvm-hosts">Configure KVM Hosts</h2><p>Use this example procedure to install the required packages
and start KVM and Open vSwitch on each undercloud and overcloud KVM
host.</p><ol type="1"><li id="LogInToOneOfTheKVMHosts.-371E5696" style="">Log in to a KVM
host.</li><li id="jd0e181" style="">Install the required packages.<div class="example" dir="ltr" id="jd0e184"><sw-code><template v-pre=""><pre>yum install -y libguestfs \
   libguestfs-tools \
   openvswitch \   
   virt-install \
   kvm libvirt \
   libvirt-python \
   python-virtualbmc \
   python-virtinst</pre></template></sw-code></div></li><li id="jd0e187" style="">Start KVM and Open vSwitch.<div class="example" dir="ltr" id="jd0e190"><sw-code><template v-pre=""><pre>systemctl start libvirtd 
systemctl start openvswitch</pre></template></sw-code></div></li><li id="CreateAndStartTheVirtualSwitchesBr0-371E5A22" style="">Additionally,
on the overcloud nodes only, create and start the virtual switches
br0 and br1.<sw-table><p class="SubTitle" id="jd0e196">Table 3: vSwitch Configuration</p><table cellspacing="0" style="border-top:thin solid black;" width="99%"><thead><tr valign="bottom"><th align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Bridge</p></th><th align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>	Trunked VLAN</p></th><th align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>	Native VLAN</p></th></tr></thead><tbody><tr valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>br0</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>710, 720, 730 740, 750</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>700</p></td></tr><tr class="row-with-bg" valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>br1</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>-</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>-</p></td></tr></tbody></table></sw-table><div class="example" dir="ltr" id="jd0e235"><sw-code><template v-pre=""><pre># Create the virtual switches and bind them to the respective interfaces.
ovs-vsctl add-br br0<br/>ovs-vsctl add-br br1<br/>ovs-vsctl add-port br0 NIC1<br/>ovs-vsctl add-port br1 NIC2
<br/>
# Create the configuration file for br0.
cat &lt;&lt; EOF &gt; br0.xml<br/>&lt;network&gt;<br/>   &lt;name&gt;br0&lt;/name&gt;<br/>   &lt;forward mode='bridge'/&gt;<br/>   &lt;bridge name='br0'/&gt;<br/>   &lt;virtualport type='openvswitch'/&gt;<br/>   &lt;portgroup name='overcloud'/&gt;<br/>      &lt;vlan trunk='yes'&gt;<br/>         &lt;tag id='700' nativeMode='untagged'/&gt;<br/>         &lt;tag id='710'/&gt;<br/>         &lt;tag id='720'/&gt;<br/>         &lt;tag id='730'/&gt;<br/>         &lt;tag id='740'/&gt;<br/>         &lt;tag id='750'/&gt;<br/>      &lt;/vlan&gt;<br/>   &lt;/portgroup&gt;<br/>&lt;/network&gt;<br/>EOF
<br/>
# Create the configuration file for br1.
cat &lt;&lt; EOF &gt; br1.xml<br/>&lt;network&gt;<br/>   &lt;name&gt;br1&lt;/name&gt;<br/>   &lt;forward mode=’bridge’/&gt;<br/>   &lt;bridge name='br1'/&gt;<br/>   &lt;virtualport type='openvswitch'/&gt;<br/>&lt;/network&gt;<br/>EOF
<br/>
# Create the br0 network based on the configuration file.
virsh net-define br0.xml<br/>virsh net-start br0<br/>virsh net-autostart br0
<br/>
# Create the br1 network based on the configuration file.
virsh net-define br1.xml<br/>virsh net-start br1<br/>virsh net-autostart br1</pre></template></sw-code></div></li><li id="jd0e308" style="">Repeat step <a href="setting-up-contrail-rhosp-infrastructure.html#LogInToOneOfTheKVMHosts.-371E5696">1</a> through step <a href="setting-up-contrail-rhosp-infrastructure.html#CreateAndStartTheVirtualSwitchesBr0-371E5A22">4</a> for each
KVM host.</li></ol><h2 id="id-create-the-overcloud-vm-definitions-on-the-overcloud-kvm-hosts">Create the Overcloud VM Definitions on the Overcloud KVM Hosts</h2><p>Use this example procedure on each overcloud KVM host
(KVM2 to KVM4) to do the following:</p><ul><li style=""><p>create the VM definitions for that overcloud KVM host</p></li><li style=""><p>create and start a virtual baseboard management controller
for that overcloud KVM host so that the VM can be managed using IPMI</p></li><li style=""><p>create an <code class="filepath">ironic_list</code> file to be used by the undercloud</p></li></ul><p>This example procedure creates a VM definition consisting of
2 compute nodes, 1 Contrail controller node, and 1 OpenStack controller
node on each overcloud KVM host.</p><ol type="1"><li id="LogInToAnOvercloudKVMHost.-3729D338" style="">Log in to an
overcloud KVM host.</li><li id="jd0e342" style="">Specify the roles you want to create.<div class="example" dir="ltr" id="jd0e345"><sw-code><template v-pre=""><pre>ROLES=compute:2,contrail-controller:1,control:1</pre></template></sw-code></div></li><li id="CreateTheVMDefinitions.InitializeAn-3729D9D3" style="">Create
the VM definitions.<div class="example" dir="ltr" id="jd0e351"><sw-code><template v-pre=""><pre># Initialize and specify the IPMI user and password you want to use.
num=0<br/>ipmi_user=&lt;user&gt;<br/>ipmi_password=&lt;password&gt;<br/>libvirt_path=<code class="filepath">/var/lib/libvirt/images</code><br/>port_group=overcloud<br/>prov_switch=br0<br/>/bin/rm ironic_list
<br/>
# For each role and instance specified in the ROLES variable:
#    - create the VM definition
#    - create and start a virtual baseboard management controller (vbmc)
#    - store the VM information into an ironic_list file (for later use in the undercloud)
IFS=',' read -ra role_list &lt;&lt;&lt; "${ROLES}"<br/>for role in ${role_list[@]}; do<br/>   role_name=`echo $role|cut -d ":" -f 1`<br/>   role_count=`echo $role|cut -d ":" -f 2`<br/>   for count in `seq 1 ${role_count}`; do<br/>      echo $role_name $count<br/>      qemu-img create -f qcow2 ${libvirt_path}/${role_name}_${count}.qcow2 99G<br/>      virsh define /dev/stdin &lt;&lt;EOF<br/>      $(virt-install --name ${role_name}_${count} \<br/>         --disk ${libvirt_path}/${role_name}_${count}.qcow2 \ <br/>         --vcpus=4 \ <br/>         --ram=16348 \ <br/>         --network network=br0,model=virtio,portgroup=${port_group} \ <br/>         --network network=br1,model=virtio \ <br/>         --virt-type kvm \ <br/>         --cpu host \ <br/>         --import \ <br/>         --os-variant rhel7 \ <br/>         --serial pty \ <br/>         --console pty,target_type=virtio \ <br/>         --graphics vnc \ <br/>         --print-xml) <br/>EOF<br/>      vbmc add ${role_name}_${count} --port 1623${num} --username ${ipmi_user} --password ${ipmi_password}<br/>      vbmc start ${role_name}_${count}     <br/>      prov_mac=`virsh domiflist ${role_name}_${count}|grep ${prov_switch}|awk '{print $5}'`<br/>      vm_name=${role_name}-${count}-`hostname -s`     <br/>      kvm_ip=`ip route get 1  |grep src |awk '{print $7}'`     <br/>      echo ${prov_mac} ${vm_name} ${kvm_ip} ${role_name} 1623${num}&gt;&gt; ironic_list<br/>      num=$(expr $num + 1)   <br/>   done <br/>done</pre></template></sw-code></div></li><li id="jd0e432" style="">Repeat step <a href="setting-up-contrail-rhosp-infrastructure.html#LogInToAnOvercloudKVMHost.-3729D338">1</a> through step <a href="setting-up-contrail-rhosp-infrastructure.html#CreateTheVMDefinitions.InitializeAn-3729D9D3">3</a> on each
overcloud KVM host.</li></ol><sw-admonition name="caution" style=""><strong class="title">Caution</strong><p>This procedure creates one <code class="filepath">ironic_list</code> file per overcloud KVM host. Combine the contents of each file into
a single <code class="filepath">ironic_list</code> file on the
undercloud.</p><p>The following shows the resulting <code class="filepath">ironic_list</code> file after you combine the contents from each separate file:</p><p><span class="screenout" v-pre="">52:54:00:e7:ca:9a compute-1-5b3s31 10.87.64.32
compute 16230 <br/>52:54:00:30:6c:3f compute-2-5b3s31 10.87.64.32
compute 16231 <br/>52:54:00:9a:0c:d5 contrail-controller-1-5b3s31
10.87.64.32 contrail-controller 16232 <br/>52:54:00:cc:93:d4
control-1-5b3s31 10.87.64.32 control 16233 <br/>52:54:00:28:10:d4
compute-1-5b3s30 10.87.64.31 compute 16230 <br/>52:54:00:7f:36:e7
compute-2-5b3s30 10.87.64.31 compute 16231 <br/>52:54:00:32:e5:3e
contrail-controller-1-5b3s30 10.87.64.31 contrail-controller 16232 <br/>52:54:00:d4:31:aa control-1-5b3s30 10.87.64.31 control 16233 <br/>52:54:00:d1:d2:ab compute-1-5b3s32 10.87.64.33 compute 16230 <br/>52:54:00:ad:a7:cc compute-2-5b3s32 10.87.64.33 compute 16231 <br/>52:54:00:55:56:50 contrail-controller-1-5b3s32 10.87.64.33
contrail-controller 16232 <br/>52:54:00:91:51:35 control-1-5b3s32
10.87.64.33 control 16233</span></p></sw-admonition><h2 id="id-create-the-undercloud-vm-definition-on-the-undercloud-kvm-host">Create the Undercloud VM Definition on the Undercloud KVM Host</h2><p>Use this example procedure on the undercloud KVM host
(KVM1) to create the undercloud VM definition and to start the undercloud
VM.</p><ol type="1"><li id="jd0e487" style="">Create the images directory.<div class="example" dir="ltr" id="jd0e490"><sw-code><template v-pre=""><pre>mkdir ~/images <br/>cd images</pre></template></sw-code></div></li><li id="jd0e495" style="">Retrieve the image.<ul><li style=""><p>CentOS</p><div class="example" dir="ltr" id="jd0e502"><sw-code><template v-pre=""><pre>curl https://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud-1802.qcow2.xz -o CentOS-7-x86_64-GenericCloud-1802.qcow2.xz
unxz -d images/CentOS-7-x86_64-GenericCloud-1802.qcow2.xz <br/>cloud_image=~/images/CentOS-7-x86_64-GenericCloud-1802.qcow2</pre></template></sw-code></div></li><li style=""><p>RHEL</p><div class="example" dir="ltr" id="jd0e510"><sw-code><template v-pre=""><pre>Download rhel-server-7.5-update-1-x86_64-kvm.qcow2 from the Red Hat portal to ~/images. 
cloud_image=~/images/rhel-server-7.5-update-1-x86_64-kvm.qcow2</pre></template></sw-code></div></li></ul></li><li id="jd0e513" style="">Customize the undercloud image.<div class="example" dir="ltr" id="jd0e516"><sw-code><template v-pre=""><pre>undercloud_name=queensa <br/>undercloud_suffix=local <br/>root_password=&lt;password&gt; <br/>stack_password=&lt;password&gt; <br/>export LIBGUESTFS_BACKEND=direct <br/>qemu-img create -f qcow2 /var/lib/libvirt/images/${undercloud_name}.qcow2 100G <br/>virt-resize --expand /dev/sda1 ${cloud_image} /var/lib/libvirt/images/${undercloud_name}.qcow2 <br/>virt-customize  -a /var/lib/libvirt/images/${undercloud_name}.qcow2 \   <br/>--run-command 'xfs_growfs /' \   <br/>--root-password password:${root_password} \   <br/>--hostname ${undercloud_name}.${undercloud_suffix} \   <br/>--run-command 'useradd stack' \   <br/>--password stack:password:${stack_password} \   <br/>--run-command 'echo "stack ALL=(root) NOPASSWD:ALL" | tee -a /etc/sudoers.d/stack' \   <br/>--chmod 0440:/etc/sudoers.d/stack \   <br/>--run-command 'sed -i "s/PasswordAuthentication no/PasswordAuthentication yes/g" /etc/ssh/sshd_config' \   <br/>--run-command 'systemctl enable sshd' \   <br/>--run-command 'yum remove -y cloud-init' \   <br/>--selinux-relabel</pre></template></sw-code></div><sw-admonition name="note" style=""><strong class="title">Note</strong><p>As part of the undercloud definition, a user called <strong v-pre="">stack</strong> is created. This user will be used later to install the
undercloud.</p></sw-admonition></li><li id="jd0e561" style="">Define the undercloud virsh template.<div class="example" dir="ltr" id="jd0e564"><sw-code><template v-pre=""><pre>vcpus=8 <br/>vram=32000 <br/>virt-install --name ${undercloud_name} \   <br/>--disk /var/lib/libvirt/images/${undercloud_name}.qcow2 \   <br/>--vcpus=${vcpus} \   <br/>--ram=${vram} \   <br/>--network network=default,model=virtio \   <br/>--network network=br0,model=virtio,portgroup=overcloud \   <br/>--virt-type kvm \   <br/>--import \   <br/>--os-variant rhel7 \   <br/>--graphics vnc \   <br/>--serial pty \   <br/>--noautoconsole \   <br/>--console pty,target_type=virtio</pre></template></sw-code></div></li><li id="jd0e595" style="">Start the undercloud VM.<div class="example" dir="ltr" id="jd0e598"><sw-code><template v-pre=""><pre>virsh start ${undercloud_name}</pre></template></sw-code></div></li><li id="jd0e601" style="">Retrieve the undercloud IP address. It might take several
seconds before the IP address is available.<div class="example" dir="ltr" id="jd0e604"><sw-code><template v-pre=""><pre>undercloud_ip=`virsh domifaddr ${undercloud_name} |grep ipv4 |awk '{print $4}' |awk -F"/" '{print $1}'` ssh-copy-id ${undercloud_ip}</pre></template></sw-code></div></li></ol><sw-prev-next> </sw-prev-next></p>