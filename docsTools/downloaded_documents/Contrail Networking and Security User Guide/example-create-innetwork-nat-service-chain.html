<p id="topic-content"><h1 id="jd0e2">Example: Creating an In-Network-NAT Service Chain</h1><sw-topic-details date="2020-05-21">Â </sw-topic-details><div id="intro"><div class="mini-toc-intro"><p>This example provides instructions to create
an in-network-nat service chain by using the Contrail Command user
interface (UI).</p></div></div><h3 id="jd0e15">Prerequisites</h3><ul><li style=""><p><strong v-pre="">Hardware and Software Requirements</strong></p><p><kbd class="user-typing" v-pre="">Hardware</kbd></p><ul><li style=""><p>Processor: 4 core x86</p></li><li style=""><p>Memory: 32GB RAM</p></li><li style=""><p>Storage: at least 128GB hard disk</p></li></ul><p><kbd class="user-typing" v-pre="">Software</kbd></p><ul><li style=""><p>Contrail Release 3.2 or later</p><sw-admonition name="note" style=""><strong class="title">Note</strong><p>For Contrail Networking Release 3.2 through Release 4.1,
you use the Contrail Web UI. For more information, see <a href="/documentation/en_US/contrail4.1/topics/example/example-create-innetwork-nat-service-chain.html">Example: Creating a In-Network-NAT Service Chain by Using Contrail
Web UI</a>.</p></sw-admonition></li></ul></li><li style=""><p><strong v-pre="">Create Network IPAM (IP Address Management)</strong></p><ol type="1"><li id="jd0e57" style="">Click <strong v-pre="">Overlay</strong>&gt;<strong v-pre="">IPAM</strong>. <p>The IP Address Management page is displayed.</p></li><li id="jd0e68" style="">Click <strong v-pre="">Create</strong> to create a new network IPAM.</li><li id="jd0e74" style="">Enter a name for the IPAM in the name field.</li><li id="jd0e77" style="">Select <strong v-pre="">Default</strong> from the DNS list.</li><li id="jd0e83" style="">Enter valid IP address in the NTP Server IP field.</li><li id="jd0e86" style="">Enter domain name in the Domain Name field.</li><li id="jd0e89" style="">Click <strong v-pre="">Create</strong>.<p>The IP Address Management page is displayed.</p></li></ol></li></ul><h3 id="jd0e97">Overview</h3><p> A service chain is a set of services that are connected across
networks. A service chain consists of service  instances, left and
right virtual networks, and a service policy attached to the networks.
A service chain can have in-network services, in-network-nat services,
and transparent services.</p><p>In an in-network-nat service chain, packets are routed between
service instance interfaces. In-network-nat service chain does not
require  return traffic to be routed to the source network. When a
packet is routed through the service chain, the source address of
the packet entering  the left interface of the service chain is updated
and is not the same as the source address of the packet exiting the
right interface. For more information, see <a href="../task/configuration/service-chaining-vnc.html">Service Chaining</a>.</p><h3 id="jd0e106">Configuration</h3><div class="mini-toc-intro"><p>These topics provide instructions to create
an in-network-nat service chain.</p></div><ul><li style=""><p><a href="example-create-innetwork-nat-service-chain.html#jd0e114">Create Virtual Network</a></p></li><li style=""><p><a href="example-create-innetwork-nat-service-chain.html#create_virtual_machine">Create Virtual Machine</a></p></li><li style=""><p><a href="example-create-innetwork-nat-service-chain.html#jd0e339">Configure Service Template</a></p></li><li style=""><p><a href="example-create-innetwork-nat-service-chain.html#jd0e457">Add Service Instance</a></p></li><li style=""><p><a href="example-create-innetwork-nat-service-chain.html#jd0e572">Create Service Policy</a></p></li><li style=""><p><a href="example-create-innetwork-nat-service-chain.html#jd0e703">Attach Service Policy</a></p></li><li style=""><p><a href="example-create-innetwork-nat-service-chain.html#jd0e756">Launch Virtual Machine</a></p></li></ul><h4 id="jd0e114">Create Virtual Network</h4><h4 id="jd0e117">Step-by-Step Procedure</h4><p>Use the Contrail Command UI to create a left virtual
network, right virtual network, and management virtual network.</p><p>To create a left virtual network:</p><ol type="1"><li id="jd0e123" style="">Click <strong v-pre="">Overlay</strong>&gt;<strong v-pre="">Virtual Networks</strong>. <p>The All Networks page is displayed.</p></li><li id="create-vn-2" style="">Click <strong v-pre="">Create</strong> to create a network.<p>The Create Virtual Network page is displayed.</p></li><li id="jd0e142" style="">In the <strong v-pre="">Name</strong> field enter <kbd class="user-typing" v-pre="">test-left-VN</kbd> for the left virtual network.</li><li id="jd0e151" style="">Select <strong v-pre="">(Default) User defined subnet only</strong> from
the <strong v-pre="">Allocation Mode</strong> list.</li><li id="jd0e160" style="">Click <strong v-pre="">+Add</strong> in the Subnets section to add subnets.<p>In the row that is displayed, </p><ol type="a"><li id="jd0e170" style="">Select an IPAM for the virtual network from the Network
IPAM list.</li><li id="jd0e173" style="">Enter <kbd class="user-typing" v-pre="">192.0.2.0/24</kbd> in the <strong v-pre="">CIDR</strong> field.</li></ol></li><li id="create-vn-10" style="">Click <strong v-pre="">Create</strong>.<p>The All Networks page is displayed. All virtual networks that
you created are displayed in this page.</p><sw-admonition name="note" style=""><strong class="title">Note</strong><p>Management network is not used to route packets. This
network is used to help debug issues with the virtual machine.</p></sw-admonition></li></ol><p>Repeat steps <a href="example-create-innetwork-nat-service-chain.html#create-vn-2">2</a> through <a href="example-create-innetwork-nat-service-chain.html#create-vn-10">6</a> to create the right virtual network (<kbd class="user-typing" v-pre="">test-right-VN</kbd>) and management virtual network (<kbd class="user-typing" v-pre="">test-mgmt-VN</kbd>).</p><h4 id="create_virtual_machine">Create Virtual Machine</h4><h4 id="jd0e208">Step-by-Step Procedure</h4><p>Follow these steps to create a left virtual machine by
using the Contrail Command UI.</p><ol type="1"><li id="jd0e212" style="">Click <strong v-pre="">Workloads</strong> &gt; <strong v-pre="">Instances</strong>.<p>The Instances page is displayed.</p></li><li id="create-vm-cc-2" style="">Click <strong v-pre="">Create</strong>.<p>The Create Instance page is displayed.</p></li><li id="jd0e231" style="">Select <strong v-pre="">Virtual Machine</strong> option button as the
serve type.</li><li id="jd0e237" style="">Enter <kbd class="user-typing" v-pre="">test-left-VM</kbd> for the
left virtual machine in the <strong v-pre="">Instance Name</strong> field.</li><li id="jd0e246" style="">Select <strong v-pre="">Image</strong> as the boot source from the <strong v-pre="">Select Boot Source</strong> list.<sw-admonition name="note" style=""><strong class="title">Note</strong><p>vSRX image with M1.large flavor is recommended for in-network-nat
virtual machine.</p></sw-admonition></li><li id="jd0e258" style="">Select <kbd class="user-typing" v-pre="">vSRX image</kbd> file from
the <strong v-pre="">Select Image</strong> list.</li><li id="jd0e267" style="">Select <kbd class="user-typing" v-pre="">M1.large</kbd> flavor from
the <strong v-pre="">Select Flavor</strong> list.</li><li id="jd0e276" style="">Select the network you want to associate with the left
virtual machine by clicking <strong v-pre="">&gt;</strong> next to the name of the virtual
machine listed in the Available Networks table. <p>For the left virtual machine, select<strong v-pre=""> test-left-VN</strong>. For the right virtual machine, select <strong v-pre="">test-right-VN</strong>.
For the management virtual machine, select <strong v-pre="">test-mgmt-VN</strong>.</p><p>The network is added to the Allocated Networks table.</p></li><li id="jd0e295" style="">Select <kbd class="user-typing" v-pre="">nova</kbd> from the <strong v-pre="">Availability
Zone</strong> list.<sw-admonition name="note" style=""><strong class="title">Note</strong><p>You can choose any other availability zone.</p></sw-admonition></li><li id="jd0e307" style="">Select <kbd class="user-typing" v-pre="">5</kbd> from the <strong v-pre="">Count
(1-10)</strong> list.<sw-admonition name="note" style=""><strong class="title">Note</strong><p>You can choose any value from 1 through 10.</p></sw-admonition></li><li id="create-vm-cc-9" style="">Click <strong v-pre="">Create</strong> to launch
the left virtual machine instance.<p>The Instances page is displayed. The virtual machine instances
that you created are listed on the Instances page.</p></li></ol><p>Repeat steps <a href="example-create-innetwork-nat-service-chain.html#create-vm-cc-2">2</a> through <a href="example-create-innetwork-nat-service-chain.html#create-vm-cc-9">11</a> to create right virtual machine instance
(<kbd class="user-typing" v-pre="">test-right-VM</kbd>) and management virtual
machine instance (<strong v-pre="">test-mgmt-VM</strong>).</p><h4 id="jd0e339">Configure Service Template</h4><h4 id="jd0e342">Step-by-Step Procedure</h4><p>Follow these steps to create a service template by using
the Contrail Command UI:</p><ol type="1"><li id="jd0e346" style="">Click <strong v-pre="">Services</strong>&gt;<strong v-pre="">Catalog</strong>. <p>The VNF Service Templates page is displayed.</p></li><li id="jd0e357" style="">Click <strong v-pre="">Create</strong>.<p>The Create VNF Service Template page is displayed.</p></li><li id="jd0e365" style="">Enter <kbd class="user-typing" v-pre="">test-service-template</kbd> in the <strong v-pre="">Name</strong> field.</li><li id="jd0e374" style="">Select <strong v-pre="">v2</strong> as the version type.<sw-admonition name="note" style=""><strong class="title">Note</strong><p>Starting with Release 3.2, Contrail supports only <em>Service Chain Version 2</em> (<strong v-pre="">v2</strong>). </p></sw-admonition></li><li id="jd0e389" style="">Select <strong v-pre="">Virtual Machine</strong> as the virtualization
type.</li><li id="jd0e395" style="">Select <strong v-pre="">In-Network Nat</strong> as the service mode.</li><li id="jd0e401" style="">Select <strong v-pre="">Firewall</strong> as the service type.</li><li id="jd0e407" style="">From the Interface section,<ul><li style=""><p>Select <strong v-pre="">left</strong> as the interface type from the <strong v-pre="">Interface Type</strong> list.</p></li><li style=""><p>Click <strong v-pre="">+ Add</strong>.</p><p>The Interface Type list is added to the table.</p><p>Select <strong v-pre="">right</strong> as the interface type.</p></li><li style=""><p>Click <strong v-pre="">+ Add</strong> again.</p><p>Another Interface Type list is added to the table.</p><p>Select <strong v-pre="">management</strong> as the interface type.</p></li></ul><sw-admonition name="note" style=""><strong class="title">Note</strong><p>The interfaces created on the virtual machine must follow
the same sequence as that of the interfaces in the service template.</p></sw-admonition></li><li id="jd0e449" style="">Click <strong v-pre="">Create</strong> to create the service template.<p>The VNF Service Templates page is displayed. The service template
that you created is displayed in the VNF Service Templates page.</p></li></ol><h4 id="jd0e457">Add Service Instance</h4><h4 id="jd0e460">Step-by-Step Procedure</h4><p>Follow these steps to add a service instance by using
the Contrail Command UI:</p><ol type="1"><li id="jd0e464" style="">Click <strong v-pre="">Services</strong>&gt;<strong v-pre="">Deployments</strong>. <p>The VNF Service Instances page is displayed.</p></li><li id="jd0e475" style="">Click <strong v-pre="">Create</strong>.<p>The Create VNF Service Instance page is displayed.</p></li><li id="jd0e483" style="">Enter <kbd class="user-typing" v-pre="">test-service-instance</kbd> in the <strong v-pre="">Name</strong> field.</li><li id="jd0e492" style="">Select <strong v-pre="">test-service-template - [in-network-nat, (left,
right, management)] - v2</strong> from the <strong v-pre="">Service Template</strong> list.<p>The <strong v-pre="">Interface Type</strong> and <strong v-pre="">Virtual Network</strong> fields are displayed.</p></li><li id="jd0e509" style="">Select the virtual network for each interface type as
given below.<ul><li style=""><p><strong v-pre="">left</strong>âSelect the left virtual network
(<strong v-pre="">test-left-VN</strong>) that you created.</p></li><li style=""><p><strong v-pre="">right</strong>âSelect the right virtual network
(<strong v-pre="">test-right-VN</strong>) that you created.</p></li><li style=""><p><strong v-pre="">management</strong>âSelect the management virtual
network (<strong v-pre="">test-management-VN</strong>) that you created.</p></li></ul></li><li id="jd0e537" style="">Click the <strong v-pre="">Port Tuples</strong> section and click <strong v-pre="">+Add</strong>.<p>Select the virtual machine instance for each interface type
as given below.</p><ul><li style=""><p><strong v-pre="">left</strong>âSelect the left virtual machine
instance that you created.</p></li><li style=""><p><strong v-pre="">right</strong>âSelect the right virtual machine
instance that you created.</p></li><li style=""><p><strong v-pre="">management</strong>âSelect the management virtual
machine instance that you created.</p></li></ul></li><li id="jd0e564" style="">Click <strong v-pre="">Create</strong> to create the service instance.<p>The VNF Service Instances page is displayed. The service instance
that you created is displayed in the VNF Service Instances page.</p></li></ol><h4 id="jd0e572">Create Service Policy</h4><h4 id="jd0e575">Step-by-Step Procedure</h4><p>Follow these steps to create a service policy by using
the Contrail Command UI.</p><ol type="1"><li id="jd0e579" style="">Click <strong v-pre="">Overlay</strong> &gt; <strong v-pre="">Network Policies</strong>. <p>The Network Policies page is displayed.</p></li><li id="jd0e590" style="">Click <strong v-pre="">Create</strong>.<p>The Network Policy tab of the Create Network Policy page is
displayed.</p></li><li id="jd0e598" style="">Enter <kbd class="user-typing" v-pre="">test-network-policy</kbd> in
the <strong v-pre="">Policy Name</strong> field.</li><li id="jd0e607" style="">In the <strong v-pre="">Policy Rule(s)</strong> section, <ul><li style=""><p>Select <strong v-pre="">pass</strong> from the <strong v-pre="">Action</strong> list.</p></li><li style=""><p>Select <strong v-pre="">ANY</strong> from the <strong v-pre="">Protocol</strong> list.</p></li><li style=""><p>Select <strong v-pre="">Network</strong> from the <strong v-pre="">Source Type</strong> list.</p></li><li style=""><p>Select the <strong v-pre="">test-left-VN</strong> from the <strong v-pre="">Source</strong> list.</p></li><li style=""><p>In the <strong v-pre="">Source Port</strong> field, leave the default
option, <strong v-pre="">Any</strong>, as is.</p></li><li style=""><p>Select <strong v-pre="">&lt; &gt;</strong> from the <strong v-pre="">Direction</strong> list.</p></li><li style=""><p>Select <strong v-pre="">Network</strong> from the <strong v-pre="">Destination Type</strong> list.</p></li><li style=""><p>Select the <strong v-pre="">test-right-VN</strong> from the <strong v-pre="">Destination</strong> list.</p></li><li style=""><p>In the <strong v-pre="">Destination Ports</strong> field, leave the default
option, <strong v-pre="">Any</strong>, as is.</p></li></ul></li><li id="jd0e695" style="">Click <strong v-pre="">Create</strong> to create the service policy.<p>The Network Policies page is displayed. All policies that you
created are displayed in the Network Policies page.</p></li></ol><h4 id="jd0e703">Attach Service Policy</h4><h4 id="jd0e706">Step-by-Step Procedure</h4><p>Follow these steps to attach a service policy:</p><ol type="1"><li id="jd0e710" style="">Click <strong v-pre="">Overlay</strong>&gt;<strong v-pre="">Virtual Networks</strong>.<p>The All networks page is displayed.</p></li><li id="jd0e721" style="">Attach service policy to the left virtual network (<strong v-pre="">test-left-VN</strong>) and right virtual network (<strong v-pre="">test-right-VN</strong>) that you created.<p>To attach service policy,</p><ol type="a"><li id="jd0e734" style="">Select the check box next to the name of the virtual network.</li><li id="jd0e737" style="">Hover over to the end of the selected row and click the <strong v-pre="">Edit</strong> icon.<p>The Edit Virtual Network page is displayed.</p></li><li id="jd0e745" style="">Select the network policy from the Network Policies list.</li></ol></li><li id="jd0e748" style="">Click <strong v-pre="">Save</strong> to save the changes.<p>The Virtual Networks page is displayed.</p></li></ol><h4 id="jd0e756">Launch Virtual Machine</h4><h4 id="jd0e759">Step-by-Step Procedure</h4><p>You can launch virtual machines from Contrail Command
and test the traffic through the service chain by doing the following:</p><ol type="1"><li id="jd0e763" style="">Launch the left virtual machine in left virtual network.
See <a href="example-create-innetwork-nat-service-chain.html#create_virtual_machine">Create Virtual Machine</a>.</li><li id="jd0e768" style="">Launch the right virtual machine in right virtual network.
See <a href="example-create-innetwork-nat-service-chain.html#create_virtual_machine">Create Virtual Machine</a>.</li><li id="jd0e773" style="">Ping the left virtual machine IP address from the right
virtual machine.<p>Follow these steps to ping a virtual machine:</p><ol type="a"><li id="jd0e779" style="">Click <strong v-pre="">Workloads</strong>&gt;<strong v-pre="">Instances</strong>.<p>The Instances page is displayed.</p></li><li id="jd0e790" style="">Click the open console icon next to <strong v-pre="">test-right-VM</strong>.<p>The Console page is displayed.</p></li><li id="jd0e798" style="">Log in using root user credentials.</li><li id="jd0e801" style="">Ping the left virtual machine IP address (<strong v-pre="">190.0.2.3</strong>) from the Console. </li></ol></li></ol><sw-prev-next>Â </sw-prev-next></p>