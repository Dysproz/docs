<p id="topic-content"><h1 id="jd0e3">Provisioning of Kubernetes Clusters</h1><sw-topic-details date="2020-10-21"> </sw-topic-details><div id="intro"><div class="mini-toc-intro"><p>Contrail Networking supports the following
ways of provisioning Kubernetes clusters:</p></div></div><h2 id="id-provisioning-of-a-standalone-kubernetes-cluster">Provisioning of a Standalone Kubernetes Cluster</h2><p>You can provision a standalone Kubernetes cluster using contrail-ansible-deployer. </p><p>Perform the following steps to install one Kubernetes
cluster and one Contrail cluster and integrate them together.</p><ol type="1"><li id="jd0e25" style="">See <a href="/documentation/en_US/contrail19/information-products/topic-collections/release-notes/topic-143725.html#jd0e140">Supported Platforms Contrail Release</a> for a list of supported
platforms.</li><li id="jd0e31" style="">Install the necessary tools.<p><code class="inline" v-pre="">yum -y install epel-release git ansible net-tools</code></p></li><li id="jd0e37" style="">Download the <code class="inline" v-pre="">contrail-ansible-deployer-19&lt;xx&gt;.&lt;NN&gt;.tgz</code> Ansible Deployer application
tool package onto your provisioning host from <a href="https://www.juniper.net/support/downloads/?p=contrail#sw">Contrail
Downloads</a> page and extract the package.<p><code class="inline" v-pre="">-
tar xvf contrail-ansible-deployer-19&lt;xx&gt;.&lt;NN&gt;.tgz</code></p></li><li id="jd0e49" style="">Navigate
to the <code class="filepath">contrail-ansible-deployer</code> directory.<p><code class="inline" v-pre="">cd contrail-ansible-deployer</code></p></li><li id="jd0e58" style="">Edit the <code class="filepath">config/instances.yaml</code> and enter the necessary values. See <a href="../../concept/install-contrail-overview-ansible-50.html">Understanding contrail-ansible-deployer used in Contrail Command</a> for a sample <code class="filepath">config/instances.yaml</code> file.</li><li id="jd0e69" style="">Turn off the <span class="cli" v-pre="">swap</span> functionality on all nodes.<p><code class="inline" v-pre="">swapoff -a</code></p></li><li id="jd0e78" style="">Configure the nodes.<p><code class="inline" v-pre="">ansible-playbook -e orchestrator=kubernetes -i
inventory/ playbooks/configure_instances.yml</code></p></li><li id="jd0e84" style="">Install Kubernetes and Contrail.<p><code class="inline" v-pre="">ansible-playbook -e orchestrator=kubernetes -i
inventory/ playbooks/install_k8s.yml</code></p><p><code class="inline" v-pre="">ansible-playbook -e orchestrator=kubernetes -i
inventory/ playbooks/install_contrail.yml </code></p></li><li id="jd0e93" style="">Turn on the <span class="cli" v-pre="">swap</span> functionality on all nodes.<p><code class="inline" v-pre="">swapon -a</code></p></li></ol><h2 id="id-provisioning-of-nested-kubernetes-clusters">Provisioning of Nested Contrail Kubernetes Clusters</h2><p>When Contrail provides networking for a Kubernetes cluster
that is provisioned on the workloads of a Contrail-OpenStack cluster,
it is called a nested Kubernetes cluster. Contrail components are
shared between the two clusters.</p><p><kbd class="user-typing" v-pre="">Prerequisites</kbd></p><p>Ensure that the following prerequisites are met before
provisioning a nested Kubernetes cluster:</p><ol type="1"><li id="jd0e117" style="">Ensure that you have an operational Contrail-OpenStack
cluster based on Contrail Networking Release 19&lt;xx&gt;..</li><li id="jd0e120" style="">Ensure that you have an operational Kubernetes v1.12.9
cluster on virtual machines created on an Contrail-OpenStack cluster.</li><li id="jd0e123" style="">Update the <code class="filepath">/etc/hosts</code> file on the Kubernetes primary node with entries for each node of
the cluster. <p>For example, if the Kubernetes cluster is made up of three nodes
such as master1 (IP: x.x.x.x), minion1 (IP: y.y.y.y), and minion2
(IP: z.z.z.z). The <code class="filepath">/etc/hosts</code> on
the Kubernetes primary node must have the following entries:</p><div class="sample" dir="ltr" id="jd0e134"><div class="output" dir="ltr"><sw-code><template v-pre=""><pre>x.x.x.x master1
y.y.y.y minion1
z.z.z.z minion2</pre></template></sw-code></div></div></li><li id="prerequisites-step4" style="">If Contrail container images
are stored in a secure docker registry, a Kubernetes secret must be
created and referenced during <a href="provisioning-k8s-cluster.html#id-generate-a-single-yaml-file-to-create-a-contrailk8s-cluster">Generate a single yaml file to create a Contrail-k8s cluster</a>, with credentials of the private docker registry.<div class="sample" dir="ltr" id="jd0e142"><div dir="ltr" id="jd0e143"><code>kubectl create secret docker-registry <var v-pre="">name</var> --docker-server=<var v-pre="">registry</var> --docker-username=<var v-pre="">username</var> --docker-password=<var v-pre="">password</var> --docker-email=<var v-pre="">email</var> -n <var v-pre="">namespace</var></code></div></div><p>Command options:</p><ul><li style=""><p><var v-pre="">name</var>—Name of the secret.</p></li><li style=""><p><var v-pre="">registry</var>—Name of the registry.
Example: hub.juniper.net/contrail.</p></li><li style=""><p><var v-pre="">username</var>—Username to log in
to the registry.</p></li><li style=""><p><var v-pre="">password</var>—Password to log in
to the registry.</p></li><li style=""><p><var v-pre="">email</var>—Registered email of the
registry account.</p></li><li style=""><p><var v-pre="">namespace</var>—Kubernetes namespace
where the secret must be created. This should be the namespace where
you intend to create the Contrail pods.</p></li></ul></li></ol><p>The following steps describe how to provision a nested Contrail
Kubernetes cluster.</p><ol><li style=""><p><a href="provisioning-k8s-cluster.html#id-create-linklocal-services-in-the-contrailopenstack-cluster">Configure network connectivity to Contrail configuration and
data plane functions.</a></p></li><li style=""><p><a href="provisioning-k8s-cluster.html#id-generate-a-single-yaml-file-to-create-a-contrailk8s-cluster">Generate a single yaml file to create a Contrail-k8s cluster</a></p></li><li style=""><p><a href="provisioning-k8s-cluster.html#id-instantiate-the-contrailk8s-cluster">Instantiate the Contrail-k8s cluster</a></p></li></ol><h3 id="id-create-linklocal-services-in-the-contrailopenstack-cluster">Configure network connectivity to Contrail configuration and
data plane functions.</h3><p>A nested Kubernetes cluster is managed by the same Contrail
control processes that manage the underlying OpenStack cluster. </p><p>The kube-manager is essentially a part of the Contrail Config
function. In a nested deployment, one kube-manager instance will is
provisioned in each overlay cluster. This necessitates the need The
kube-manager running in the overlay must have network reachability
to Contrail config functions of the underlay OpenStack cluster.  </p><p>Network connectivity for the following Contrail config functions
are required:</p><ul><li style=""><p>Contrail Config</p></li><li style=""><p>Contrail Analytics </p></li><li style=""><p>Contrail Msg Queue </p></li><li style=""><p>Contrail VNC DB </p></li><li style=""><p>Keystone</p></li></ul><p>In addition to config connectivity, the CNI for the Kubernetes
cluster needs network reachability to the vRouter on its Compute node.
Network connectivity for the vRouter data plane function is also required.</p><p>You can use the link local service feature or a combination
of link local service with fabric Source Network Address Translation
(SNAT) feature of Contrail to provide IP reachability to and from
the overlay Kubernetes cluster config and data components to corresponding
config and data compoenents of the underlay OpenStack cluster.</p><p>To provide IP reachability to and from the Kubernetes
cluster using the fabric SNAT with link local service, perform the
following steps.</p><ol type="1"><li id="jd0e235" style="">Enable fabric SNAT on the virtual network of the VMs.<p>The fabric SNAT feature must be enabled on the virtual network
of the virtual machines on which the Kubernetes primary and minions
are running.</p></li><li id="jd0e240" style="">Create a link local service for the Container Network
Interface (CNI) to communicate with its vRouter Agent. This link local
service should be configured using the Contrail GUI, in the following
example:</li></ol><sw-table><table cellspacing="0" style="border-top:thin solid black;" width="99%"><tbody><tr valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Contrail Process</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Service IP</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Service Port</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Fabric IP</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Fabric Port</p></td></tr><tr class="row-with-bg" valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>vRouter</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p><var v-pre="">Service-IP for the active node</var></p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>9091</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>127.0.0.1</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>9091</p></td></tr></tbody></table></sw-table><sw-admonition name="note" style=""><strong class="title">Note</strong><p> Fabric IP address is 127.0.0.1 since you must make the
CNI communicate with the vRouter on its underlay node.</p></sw-admonition><p>For example, the following link local services must be created:</p><sw-table><table cellspacing="0" style="border-top:thin solid black;" width="99%"><tbody><tr valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Link Local Service Name</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Service IP</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Service Port</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Fabric IP</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>Fabric Port</p></td></tr><tr class="row-with-bg" valign="top"><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>K8s-cni-to-agent</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>10.10.10.5</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>9091</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>127.0.0.1</p></td><td align="left" style="border-bottom:thin solid black;text-align: left;padding-right: 10px;padding-left: 10px;"><p>9091</p></td></tr></tbody></table></sw-table><sw-admonition name="note" style=""><strong class="title">Note</strong><p>Here 10.10.10.5 is the Service IP address that you chose.
This can be any unused IP in the cluster. This IP address is primarily
used to identify link local traffic and has no other significance.</p></sw-admonition><h3 id="id-generate-a-single-yaml-file-to-create-a-contrailk8s-cluster">Generate a single yaml file to create a Contrail-k8s cluster</h3><p>Contrail components are installed on the Kubernetes cluster
as pods. The configuration to create these pods in Kubernetes is encoded
in a yaml file.</p><p>This file can be generated as follows:</p><ol type="1"><li id="jd0e343" style="">Download the <code class="inline" v-pre="">contrail-ansible-deployer-19&lt;xx&gt;.&lt;NN&gt;.tgz</code> Ansible
Deployer application tool package onto your provisioning host from <a href="https://www.juniper.net/support/downloads/?p=contrail#sw">Juniper
Networks</a> and extract the package.<p><code class="inline" v-pre="">- tar xvf contrail-ansible-deployer-19&lt;xx&gt;.&lt;NN&gt;.tgz</code></p></li><li id="jd0e355" style="">Navigate
to the <code class="filepath">contrail-container-builder</code> directory.<p><code class="inline" v-pre="">cd contrail-container-builder</code></p></li><li id="jd0e364" style="">Populate the <code class="filepath">common.env</code> file located in the top directory of the cloned contrail-container-builder
repo with information corresponding to your cluster and environment.
 <p>For a sample <code class="filepath">common.env</code> file
with the required bare minimum configurations, see the <a href="https://github.com/tungstenfabric/tf-container-builder/blob/master/kubernetes/sample_config_files/common.env.sample.nested_mode">common.env.sample.nested_mode</a> sample configuration file.</p><sw-admonition name="note" style=""><strong class="title">Note</strong><p>If Contrail container images are stored in a secure docker
registry, a Kubernetes secret must be created and referenced  as documented
in <a href="provisioning-k8s-cluster.html#prerequisites-step4">4</a> of Prerequisites. Populate
the variable KUBERNETES_SECRET_CONTRAIL_REPO=&lt;<var v-pre="">secret-name</var>&gt; with the name of the generated Kubernetes secret, in the <code class="filepath">common.env</code> file.</p></sw-admonition></li><li id="yaml-step3" style="">Generate the yaml file as following in
your shell:<div class="sample" dir="ltr" id="jd0e392"><div class="output" dir="ltr"><sw-code><template v-pre=""><pre>cd <var v-pre="">contrail-container-build-repo</var>/kubernetes/manifests

./resolve-manifest.sh contrail-kubernetes-nested.yaml  &gt; nested-contrail.yml</pre></template></sw-code></div></div></li><li id="jd0e398" style="">Copy the output (or file) generated from <a href="provisioning-k8s-cluster.html#yaml-step3">4</a> to the primary node in your Kubernetes cluster.</li></ol><h3 id="id-instantiate-the-contrailk8s-cluster">Instantiate the Contrail-k8s cluster</h3><p>Create contrail components as pods on the Kubernetes cluster.</p><div class="sample" dir="ltr" id="jd0e410"><div class="output" dir="ltr"><sw-code><template v-pre=""><pre>root@k8s:~# kubectl get pods -n kube-system
NAME                                  READY     STATUS    RESTARTS   AGE
contrail-kube-manager-lcjbc           1/1       Running   0          3d
contrail-kubernetes-cni-agent-w8shc   1/1       Running   0          3d</pre></template></sw-code></div></div><p>You will see the following pods running in the kube-system namespace:</p><p>contrail-kube-manager-xxxxxx—This is the manager that
acts as conduit between Kubernetes and OpenStack clusters  </p><p>contrail-kubernetes-cni-agent-xxxxx—This installs and
configures Contrail CNI on Kubernetes nodes</p><h2 id="id-provisioning-of-nonnested-kubernetes-clusters">Provisioning of Non-Nested Contrail Kubernetes Clusters</h2><p>In non-nested mode, a Kubernetes cluster is provisioned side
by side with an OpenStack cluster with networking provided by the
same Contrail components of the OpenStack cluster.</p><p><kbd class="user-typing" v-pre="">Prerequisites</kbd></p><p>Ensure that the following prerequisites are met before
provisioning a non-nested Kubernetes cluster:</p><ol type="1"><li id="jd0e434" style="">You must have an installed and operational Contrail OpenStack
cluster based on the Contrail Networking Release 19<var v-pre="">xx</var> release.</li><li id="jd0e440" style="">You must have an installed and operational Kubernetes
cluster on the server where you want to install the non-nested Contrail
Kubernetes cluster.</li><li id="jd0e443" style="">Label the Kubernetes primary node with the Contrail controller
label:<div class="sample" dir="ltr" id="jd0e446"><div dir="ltr" id="jd0e447"><code>kubectl label node <var v-pre="">node</var> node-role.opencontrail.org/config=true</code></div></div></li><li id="jd0e452" style="">Ensure that the Kubelet running on the Kubernetes primary
node is not run with network plugin options. If kubelet is running
with network plugin option, then disable or comment out the KUBELET_NETWORK_ARGS
option in the <code class="filepath">/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> configuration file.<sw-admonition name="note" style=""><strong class="title">Note</strong><p>It is recommended that the Kubernetes primary should not
be configured with a network plugin, so as to not install vRouter
kernel module on the control node. However, this is optional.</p></sw-admonition></li><li id="jd0e461" style="">Restart the kubelet service:<div class="sample" dir="ltr" id="jd0e464"><div dir="ltr" id="jd0e465"><code>systemctl daemon-reload; </code></div><div dir="ltr" id="jd0e467"><code>systemctl restart kubelet.service</code></div></div></li></ol><p><kbd class="user-typing" v-pre="">Provisioning a Contrail Kubernetes Cluster</kbd></p><p>Follow these steps to provision Contrail Kubernetes cluster.</p><ol type="1"><li id="jd0e476" style="">Download the <code class="inline" v-pre="">contrail-ansible-deployer-19<var v-pre="">&lt;xx&gt;.&lt;NN&gt;</var>.tgz</code> Ansible Deployer application tool package onto
your provisioning host from <a href="https://www.juniper.net/support/downloads/?p=contrail#sw">Juniper
Networks</a> and extract the package.<p><code class="inline" v-pre="">- tar xvf contrail-ansible-deployer-19&lt;xx&gt;.&lt;NN&gt;.tgz</code></p></li><li id="jd0e491" style="">Navigate to the <code class="filepath">contrail-container-builder</code> directory.<p><code class="inline" v-pre="">cd contrail-container-builder</code></p></li><li id="jd0e500" style="">Populate the <code class="filepath">common.env</code> file located in the top directory of the cloned contrail-container-builder
repo with information corresponding to your cluster and environment.
 <p>For a sample <code class="filepath">common.env</code> file
with required bare minimum configurations, see the <a href="https://github.com/tungstenfabric/tf-container-builder/blob/master/kubernetes/sample_config_files/common.env.sample.non_nested_mode"> common.env.sample.non_nested_mode</a> sample configuration file.</p><sw-admonition name="note" style=""><strong class="title">Note</strong><p>If Config API is not secured by keystone, ensure that <var v-pre="">AUTH_MODE</var> and <var v-pre="">KEYSTONE_*</var> variables
are not configured or present while populating the <code class="filepath">common.env</code> file.</p></sw-admonition></li><li id="non-nested-step3" style="">Generate the yaml file as shown
below:<div class="sample" dir="ltr" id="jd0e529"><div class="output" dir="ltr"><sw-code><template v-pre=""><pre>cd <var v-pre="">contrail-container-build-repo</var>/kubernetes/manifests

./resolve-manifest.sh contrail-kubernetes-nested.yaml  &gt; non-nested-contrail.yml</pre></template></sw-code></div></div></li><li id="jd0e535" style="">Copy the file generated from <a href="provisioning-k8s-cluster.html#non-nested-step3">4</a> to the primary node in your Kubernetes cluster.</li><li id="jd0e540" style="">Create contrail components as pods on the Kubernetes cluster
as follows:<div class="sample" dir="ltr" id="jd0e543"><div dir="ltr" id="jd0e544"><code>kubectl apply -f non-nested-contrail.yml</code></div></div></li><li id="jd0e546" style="">Create the following Contrail pods on the Kubernetes cluster.
Ensure that contrail-agent pod is created only on the worker node.<div class="sample" dir="ltr" id="jd0e549"><div class="output" dir="ltr"><sw-code><template v-pre=""><pre>[root@b4s403 manifests]# kubectl get pods --all-namespaces -o wide
       NAMESPACE     NAME                             READY     STATUS    RESTARTS   AGE       IP            NODE
       kube-system   contrail-agent-mxkcq             2/2       Running   0          1m        &lt;x.x.x.x&gt;     b4s402
       kube-system   contrail-kube-manager-glw5m      1/1       Running   0          1m        &lt;x.x.x.x&gt;     b4s403</pre></template></sw-code></div></div></li></ol><sw-prev-next> </sw-prev-next></p>